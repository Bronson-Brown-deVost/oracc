#!/usr/bin/perl
use warnings; use strict;

my $oracc = '@@ORACC@@';
my $oracc_builds = '@@ORACC_BUILDS@@';

sub xsystem;

my $dry = shift @ARGV;

my @BUILD_HOSTS = qw/oracc.museum.upenn.edu/;

foreach my $buildhost (@BUILD_HOSTS) {
    my @servelist = `curl -s http://$buildhost/srv`; chomp @servelist;
    foreach my $s (@servelist) {
	my($project,$datestamp) = split(/\s+/,$s);
	my $installstamp = ((stat("$oracc_builds/$project/installstamp"))[9] || 0);
	if ($datestamp > $installstamp) {
	    xsystem "/bin/sh", "$oracc/bin/serve-install.sh", $project, $buildhost;
	}
    }
}

sub
xsystem {
    warn "@_\n";
    system(@_) unless $dry;
}

1;
